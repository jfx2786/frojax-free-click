<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0f1115">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="assets/icon-192.png">
<title>Frojax Free Click • Metrónomo</title>
<style>
  :root{--bg:#000000; --panel:#0b0b0b; --muted:#b4b4b4; --text:#ffffff; --accent:#d4af37; --accent2:#b38b2e; --danger:#ef4444; --ok:#22c55e; --shadow:0 10px 24px rgba(0,0,0,.5); --radius:16px; --beat:#ffffff; --beat-accent:#d4af37;}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  body{margin:0;background:radial-gradient(1200px 800px at 80% -10%,#111111 0%,#000000 60%);color:var(--text)}
  header{padding:18px 16px;text-align:center}
  header h1{margin:0;font-size:clamp(18px,3.5vw,28px);font-weight:700;letter-spacing:.2px}
  header p{margin:6px 0 0;color:var(--muted);font-size:14px}
  .wrap{max-width:980px;margin:0 auto;padding:10px 14px 40px;display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:960px){.wrap{grid-template-columns:1.1fr .9fr}}
  .card{background:linear-gradient(180deg,#1a1f2a 0%,#141820 100%);border:1px solid #1a1a1a;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .stack{display:grid;gap:10px}
  .label{font-size:12px;color:#9aa3b2;text-transform:uppercase;letter-spacing:.08em}
  .big{font-size:clamp(40px,8vw,84px);font-weight:800;line-height:1;margin:4px 0}
  .sub{color:#a6adbb}
  button,select,input[type="number"]{
    background:#0f131a;border:1px solid #263043;color:var(--text);
    padding:10px 14px;border-radius:12px;font-size:15px
  }
  button{cursor:pointer;transition:transform .02s ease,background .2s,opacity .2s;display:inline-flex;align-items:center;justify-content:center;text-align:center}
  button:active{transform:translateY(1px)}
  button.primary{background:linear-gradient(180deg,#1a1a1a,#0f0f0f);border-color:#4a3b11}
  button.good{background:linear-gradient(180deg,#1a1a1a,#0d0d0d);border-color:#6f5816; box-shadow:0 0 0 1px rgba(212,175,55,.25) inset}
  button.warn{background:linear-gradient(180deg,#1a1a1a,#0d0d0d);border-color:#6f5816}
  button.danger{background:linear-gradient(180deg,#2a0f0f,#1a0a0a);border-color:#7a2b2b}
  .pill{border-radius:999px;padding:10px 16px;font-weight:700}
  .grow{flex:1}
  .center{display:flex;align-items:center;justify-content:center}
  .controls{display:grid;gap:12px}
  .slider{appearance:none;width:100%;height:12px;border-radius:999px;background:#0d1117;border:1px solid #2a3346}
  .slider::-webkit-slider-thumb{appearance:none;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#d4af37,#b38b2e);border:1px solid #1f2937}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:560px){.grid{grid-template-columns:1fr}}
  .hint{color:#c9c9c9;font-size:12px}
  .sep{height:1px;background:#242b36;margin:6px 0}
  .kbd{background:#0f131a;border:1px solid #263043;border-radius:6px;padding:2px 6px;font-size:12px}
  .tiny{font-size:12px;color:#cfcfcf}

  /* Luz de pulso más grande */
  .lamp-wrap{display:flex;align-items:center;gap:14px;margin-top:8px}
  .lamp{
    width:120px;height:120px;border-radius:50%;
    background:#0d1117;border:2px solid #2a2a2a;
    box-shadow:0 0 0 rgba(0,0,0,0);
    transition:transform .04s ease;
  }
  .lamp.flash{ animation: flash .12s ease-out; }
  .lamp.accent{ border-color:#7c5c0a; }
  @keyframes flash{
    0%{ box-shadow:0 0 0 rgba(0,0,0,0); transform:scale(1); }
    30%{ box-shadow:0 0 32px var(--glow); transform:scale(1.06); }
    100%{ box-shadow:0 0 0 rgba(0,0,0,0); transform:scale(1); }
  }

  /* Pastillas de acento por pulso */
  .accent-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .beat-pill{
    min-width:44px; padding:8px 10px; border-radius:999px; text-align:center; font-weight:700;
    background:#0f131a;border:1px solid #2a3346; cursor:pointer; user-select:none
  }
  .beat-pill.accent{background:linear-gradient(180deg,#1a1a1a,#0f0f0f);border-color:#6f5816; box-shadow:0 0 0 1px rgba(212,175,55,.3) inset}
  .beat-pill.accent::after{content:" ★"; color:#d4af37}

  <style>
    #trainerCard.active{background:linear-gradient(180deg,#141414 0%,#0f0f0f 100%);border-color:#3a2e0f;}
    #trainerToggle.active{background:linear-gradient(180deg,#2a2a2a,#151515);border-color:#d4af37;box-shadow:0 0 0 1px rgba(212,175,55,.35) inset}
  
  <style>
    .trainer-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;      font-weight:700;font-size:12px;letter-spacing:.04em;border:1px solid #2a2a2a;background:#0f0f0f;color:#cfcfcf}
    .trainer-chip.on{border-color:#d4af37;color:#000;background:linear-gradient(180deg,#d4af37,#b38b2e)}
    .trainer-chip.off{opacity:.75}
    .trainer-summary{font-size:12px;color:#cfcfcf}
    #trainerCard.active input[type="number"],
    #trainerCard.active select{
      border-color:#6f5816; box-shadow:0 0 0 1px rgba(212,175,55,.25) inset;
    }
    #trainerStartBtn[disabled]{opacity:.6;cursor:not-allowed}
  
  <style>
    .logo-title {
      color: #d4af37;
      font-weight: 900;
      font-size: clamp(28px, 5vw, 42px);
      text-align: center;
      letter-spacing: 1px;
      margin: 16px 0;
    }
  </style>
</style>

  <style>
    .logo-title {
      color: #d4af37;
      font-weight: 900;
      font-size: clamp(28px, 5vw, 42px);
      text-align: center;
      letter-spacing: 1px;
      margin: 16px 0;
    }
  </style>
</style>

  <style>
    .logo-title {
      color: #d4af37;
      font-weight: 900;
      font-size: clamp(28px, 5vw, 42px);
      text-align: center;
      letter-spacing: 1px;
      margin: 16px 0;
    }
  </style>
</style>
</head>
<body>
  <header>
  <h1 class="logo-title">FROJAX FREE CLICK</h1>
</header>

  <div class="wrap">
    <!-- IZQUIERDA: Transporte / Tempo -->
    <section id="trainerCard" class="card stack">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="label">Tempo</div>
          <div id="bpmDisplay" class="big">120</div>
          <div class="sub hint">
            Alternar: <span class="kbd">Espacio</span> • Tap: <span class="kbd">T</span>
          </div>
          <div class="lamp-wrap">
            <div id="lamp" class="lamp" title="Pulso"></div>
            
          </div>
        </div>
        <div class="center" style="gap:10px;flex-wrap:wrap">
          <button id="toggleBtn" class="good pill" style="min-width:160px">Reproducir</button>
          <button id="tapBtn" class="pill">Tap</button>
          <button id="resetTapBtn" class="pill">Reiniciar Tap</button>
        </div>
      </div>

      <div class="controls">
        <div class="row" style="gap:12px;align-items:center">
          <div class="label">BPM</div>
          <input id="bpmSlider" class="slider grow" type="range" min="30" max="300" value="120" />
          <input id="bpmInput" type="number" min="30" max="300" value="120" style="width:88px" />
        </div>

        <div class="grid">
          <div class="card" style="padding:12px">
            <div class="label">Compás</div>
            <div class="row" style="margin-top:6px">
              <select id="numSelect"></select>
              <span style="font-size:18px;font-weight:700">/</span>
              <select id="denSelect">
                <option value="2">2</option>
                <option value="4" selected>4</option>
                <option value="8">8</option>
                <option value="16">16</option>
              </select>
            </div>
            <div class="hint" style="margin-top:6px">Toca las pastillas para acentuar/desacentuar cada pulso.</div>
            <div id="accentBar" class="accent-bar"></div>
          </div>

          <div class="card" style="padding:12px">
            <div class="label">Sonido</div>
            <div class="row" style="margin-top:6px;gap:8px">
              <select id="soundSelect">
                <option value="tick" selected>Tick</option>
                <option value="click">Click</option>
                <option value="cowbell">Cowbell</option>
              </select>
              <div class="row" style="margin-left:auto;gap:8px">
                <span class="label">Vol</span>
                <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" class="slider" style="width:160px" />
              </div>
            </div>
          </div>
        </div>
        <div id="trainerHelp" class="hint" style="margin-top:8px; display:none">Flujo: activa el entrenador, ajusta BPM inicial/final y duración, luego presiona <strong>“Reproducir”</strong> para comenzar.</div>
    </div>
    </section>

    <!-- DERECHA: Entrenador -->
    <section class="card stack">
      <div class="row" style="justify-content:space-between;align-items:center">
  <div class="stack" style="min-width:240px">
    <div class="label">Entrenador</div>
    <div class="sub">Sube el BPM desde un inicio hasta un final durante un tiempo.</div>
    <div class="row" style="gap:8px;align-items:center;margin-top:6px">
      <span id="trainerStatus" class="trainer-chip off" title="Estado del entrenador">OFF</span>
      <span id="trainerSummary" class="trainer-summary">Inicio: 90 BPM • Final: 140 BPM • Duración: 10 min</span>
    </div>
  </div>
  <div class="row" style="gap:8px;align-items:center">
    <button id="trainerToggle" class="pill primary" style="min-width:200px">Activar entrenador</button>
    <button id="trainerStartBtn" class="pill good" style="min-width:140px;display:none">Iniciar</button>
  </div>
</div>

      <div class="grid">
        <div class="stack">
          <label class="label">BPM inicial</label>
          <input id="trainerStart" type="number" min="30" max="300" value="90" />
        </div>
        <div class="stack">
          <label class="label">BPM final</label>
          <input id="trainerEnd" type="number" min="30" max="300" value="140" />
        </div>
        <div class="stack">
          <label class="label">Duración (minutos)</label>
          <input id="trainerMinutes" type="number" min="1" max="120" value="10" />
        </div>
        <div class="stack">
          <label class="label">Avance</label>
          <select id="trainerMode">
            <option value="continuous" selected>Continuo</option>
            <option value="perbar">Por compás</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between">
        <div class="tiny">
          Consejo: en <em>Por compás</em> el BPM sube un poco al iniciar cada compás.<br/>
          En <em>Continuo</em> cambia suavemente en cada pulso.
        </div>
        
        <div id="trainerHelp" class="hint" style="margin-top:8px; display:none">Flujo: activa el entrenador, ajusta BPM inicial/final y duración, luego presiona <strong>“Reproducir”</strong> para comenzar.</div>
    </div>
    </section>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const toggleBtn = $('#toggleBtn');
  const tapBtn = $('#tapBtn');
  const resetTapBtn = $('#resetTapBtn');
  const bpmSlider = $('#bpmSlider');
  const bpmInput = $('#bpmInput');
  const bpmDisplay = $('#bpmDisplay');
  const numSelect = $('#numSelect');
  const denSelect = $('#denSelect');
  const soundSelect = $('#soundSelect');
  const vol = $('#vol');
  const trainerToggle = $('#trainerToggle');
  const trainerStart = $('#trainerStart');
  const trainerEnd = $('#trainerEnd');
  const trainerMinutes = $('#trainerMinutes');
  const trainerMode = $('#trainerMode');
  const trainerCard = $('#trainerCard');
  const trainerHelp = $('#trainerHelp');
  const trainerStatus = $('#trainerStatus');
  const trainerSummary = $('#trainerSummary');
  const trainerStartBtn = $('#trainerStartBtn');
  const accentBar = $('#accentBar');
  const lamp = $('#lamp');

  // Numerador 1..12
  for(let i=1;i<=12;i++){ 
    const o=document.createElement('option'); 
    o.value=i; o.textContent=i; if(i===4)o.selected=true; 
    numSelect.appendChild(o); 
  }

  const state = {
    isRunning:false,
    bpm:120,
    num:4, den:4,
    accents:[], // bool por pulso
    currentBeat:0,
    nextNoteTime:0,
    lookaheadMs:25,
    scheduleAheadSec:0.15,
    tapTimes:[],
    trainer:{
      enabled:false,
      startBpm:90,
      endBpm:140,
      minutes:10,
      mode:'continuous',
      startTimeAudio:null
    }
  };

  // Construir barra de acentos según numerador
  function buildAccentBar(){
    accentBar.innerHTML='';
    state.accents = Array.from({length: state.num}, (_,i)=> i===0); // por defecto acento en 1
    for(let i=0;i<state.num;i++){
      const btn = document.createElement('button');
      btn.className='beat-pill'+(state.accents[i]?' accent':'');
      btn.textContent = (i+1);
      btn.addEventListener('click', ()=>{
        state.accents[i] = !state.accents[i];
        btn.classList.toggle('accent', state.accents[i]);
      });
      accentBar.appendChild(btn);
    }
  }
  buildAccentBar();

  // Audio
  let audioCtx = null;
  let masterGain = null;
  const schedulerTimers = { intervalId:null };

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = parseFloat(vol.value);
      masterGain.connect(audioCtx.destination);
    }
  }
  vol.addEventListener('input', ()=>{ if(masterGain) masterGain.gain.value = parseFloat(vol.value); });

  // Sonidos (acento usa mayor tono/volumen)
  function clickTick(time, isAccent){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type='sine';
    osc.frequency.setValueAtTime(isAccent? 2200 : 1600, time);
    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(isAccent?1.0:0.7, time+0.001);
    gain.gain.exponentialRampToValueAtTime(0.0001, time+0.06);
    osc.connect(gain).connect(masterGain);
    osc.start(time);
    osc.stop(time+0.07);
  }

  function clickNoise(time, isAccent){
    const bufferSize = 0.05 * audioCtx.sampleRate;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    const amp = isAccent ? 1.0 : 0.7;
    for(let i=0;i<buffer.length;i++){ data[i] = (Math.random()*2-1) * amp; }
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    const hp = audioCtx.createBiquadFilter();
    hp.type='highpass'; hp.frequency.value = 3000;
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(1, time);
    gain.gain.exponentialRampToValueAtTime(0.001, time+0.03);
    src.connect(hp).connect(gain).connect(masterGain);
    src.start(time);
    src.stop(time+0.06);
  }

  function cowbell(time, isAccent){
    const o1 = audioCtx.createOscillator(); o1.type='square'; o1.frequency.setValueAtTime(isAccent?600:540, time);
    const o2 = audioCtx.createOscillator(); o2.type='square'; o2.frequency.setValueAtTime(isAccent?860:800, time);
    const bp = audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 800; bp.Q.value=3.5;
    const gain = audioCtx.createGain();
    const v = isAccent?1.1:0.85;
    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(v, time+0.001);
    gain.gain.exponentialRampToValueAtTime(0.0001, time+0.09);
    o1.connect(bp); o2.connect(bp); bp.connect(gain).connect(masterGain);
    o1.start(time); o2.start(time);
    o1.stop(time+0.1); o2.stop(time+0.1);
  }

  function playBeat(time){
    const beatIndex = state.currentBeat % state.num;
    const isAccent = !!state.accents[beatIndex];
    const sound = soundSelect.value;
    if(sound === 'tick') clickTick(time, isAccent);
    else if(sound === 'click') clickNoise(time, isAccent);
    else if(sound === 'cowbell') cowbell(time, isAccent);

    // Visual sincronizada
    const dt = Math.max(0, (time - (audioCtx?.currentTime || 0)) * 1000);
    setTimeout(()=> flashLamp(isAccent), dt);
  }

  function flashLamp(isAccent){
    const color = isAccent ? 'var(--beat-accent)' : 'var(--beat)';
    lamp.style.setProperty('--glow', isAccent ? 'rgba(250, 204, 21, 0.75)' : 'rgba(96,165,250,0.6)');
    lamp.style.background = color;
    lamp.classList.toggle('accent', isAccent);
    lamp.classList.remove('flash');
    void lamp.offsetWidth; // reiniciar animación
    lamp.classList.add('flash');
    setTimeout(()=>{
      lamp.style.background = '#0d1117';
      lamp.classList.remove('accent');
    }, 140);
  }

  // Scheduler
  function secondsPerBeatFromBpm(bpm, den){
    const quarterSec = 60.0 / bpm;
    return quarterSec * (4/den);
  }

  function schedule(){
    while(state.nextNoteTime < (audioCtx.currentTime + state.scheduleAheadSec)){
      playBeat(state.nextNoteTime);
      advanceTrainerIfNeeded();
      const spb = secondsPerBeatFromBpm(state.bpm, state.den);
      state.nextNoteTime += spb;
      state.currentBeat = (state.currentBeat + 1) % state.num;
      if(state.currentBeat === 0 && state.trainer.enabled && state.trainer.mode === 'perbar'){
        updateTrainerBpmPerBar();
      }
    }
  }

  function startScheduler(){
    if(schedulerTimers.intervalId) return;
    schedulerTimers.intervalId = setInterval(schedule, state.lookaheadMs);
  }
  function stopScheduler(){
    clearInterval(schedulerTimers.intervalId);
    schedulerTimers.intervalId = null;
  }

  // Toggle Play/Detener
  function play(){
    ensureAudio();
    if(audioCtx.state === 'suspended'){ audioCtx.resume(); }
    state.isRunning = true;
    toggleBtn.textContent = 'Detener';
    toggleBtn.classList.remove('good');
    toggleBtn.classList.add('danger');
    state.currentBeat = 0;
    state.nextNoteTime = audioCtx.currentTime + 0.1;
    if(state.trainer.enabled){
      state.trainer.startTimeAudio = audioCtx.currentTime;
    }
    startScheduler();
    updatePlayLabels();
  }
  function stop(){
    state.isRunning = false;
    toggleBtn.textContent = 'Reproducir';
    toggleBtn.classList.remove('danger');
    toggleBtn.classList.add('good');
    stopScheduler();
    updatePlayLabels();
  }
  toggleBtn.addEventListener('click', ()=> state.isRunning ? stop() : play());

  // Teclado
  window.addEventListener('keydown', (e)=>{
    if(e.target && ['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;
    if(e.code==='Space'){ e.preventDefault(); state.isRunning ? stop() : play(); }
    if(e.key.toLowerCase()==='t'){ e.preventDefault(); doTap(); }
  });

  // BPM
  function setBpm(val){
    const v = Math.min(300, Math.max(30, Math.round(val)));
    state.bpm = v;
    bpmSlider.value = v;
    bpmInput.value = v;
    bpmDisplay.textContent = v;
  }
  bpmSlider.addEventListener('input', ()=> setBpm(parseInt(bpmSlider.value,10)));
  bpmInput.addEventListener('input', ()=> setBpm(parseInt(bpmInput.value||0,10)));

  // Tap
  function doTap(){
    const now = performance.now();
    const taps = state.tapTimes;
    if(taps.length && (now - taps[taps.length-1] > 2000)){ taps.length = 0; }
    taps.push(now);
    if(taps.length >= 3){
      const intervals = [];
      for(let i=1;i<taps.length;i++) intervals.push(taps[i]-taps[i-1]);
      intervals.sort((a,b)=>a-b);
      const mid = intervals.slice(1, intervals.length-1);
      const avg = (mid.length? mid:intervals).reduce((a,b)=>a+b,0) / (mid.length? mid.length: intervals.length);
      const bpm = Math.round(60000 / avg);
      setBpm(bpm);
    }
  }
  tapBtn.addEventListener('click', doTap);
  resetTapBtn.addEventListener('click', ()=> state.tapTimes.length = 0);

  // Trainer
  function readTrainerUI(){
    /* trainer enabled handled by toggle button */
    state.trainer.startBpm = clamp(parseInt(trainerStart.value||0,10),30,300);
    state.trainer.endBpm = clamp(parseInt(trainerEnd.value||0,10),30,300);
    state.trainer.minutes = clamp(parseInt(trainerMinutes.value||0,10),1,120);
    state.trainer.mode = trainerMode.value;
  }
  function clamp(n,min,max){ return isNaN(n)?min: Math.min(max,Math.max(min,n)); }
  ;[trainerStart, trainerEnd, trainerMinutes, trainerMode].forEach(el=> el.addEventListener('input', readTrainerUI));
  
  readTrainerUI();

  function trainerProgress(nowAudio){
    const elapsed = nowAudio - (state.trainer.startTimeAudio ?? nowAudio);
    const total = state.trainer.minutes * 60;
    const t = Math.min(1, Math.max(0, total>0? elapsed/total : 1));
    return { t, totalSec: total };
  }
  function advanceTrainerIfNeeded(){
    if(!state.trainer.enabled || !audioCtx) return;
    if(state.trainer.mode !== 'continuous') return;
    const prog = trainerProgress(audioCtx.currentTime);
    const nextBpm = Math.round(state.trainer.startBpm + (state.trainer.endBpm - state.trainer.startBpm) * prog.t);
    if(nextBpm !== state.bpm) setBpm(nextBpm);
    if(prog.t >= 1 && state.isRunning) stop();
  }
  function updateTrainerBpmPerBar(){
    if(!state.trainer.enabled || !audioCtx) return;
    if(state.trainer.mode !== 'perbar') return;
    const prog = trainerProgress(audioCtx.currentTime);
    const nextBpm = Math.round(state.trainer.startBpm + (state.trainer.endBpm - state.trainer.startBpm) * prog.t);
    if(nextBpm !== state.bpm) setBpm(nextBpm);
    if(prog.t >= 1 && state.isRunning) stop();
  }

  
  // Toggle entrenador (cambia estilo y muestra mensaje)

  function updatePlayLabels(){
    const running = state.isRunning;
    const toggleBtn = document.querySelector('#toggleBtn');
    if(toggleBtn){
      toggleBtn.textContent = running ? 'Detener' : 'Reproducir';
      toggleBtn.classList.toggle('danger', running);
      toggleBtn.classList.toggle('good', !running);
    }
    if(trainerStartBtn && trainerStartBtn.style.display !== 'none'){
      trainerStartBtn.textContent = running ? 'Detener' : 'Iniciar';
    }
  }


  function updateTrainerSummary(){
    const sBpm = Number(trainerStart.value || 0);
    const eBpm = Number(trainerEnd.value || 0);
    const mins = Number(trainerMinutes.value || 0);
    trainerSummary.textContent = `Inicio: ${sBpm} BPM • Final: ${eBpm} BPM • Duración: ${mins} min`;
  }
  [trainerStart, trainerEnd, trainerMinutes].forEach(el => el.addEventListener('input', updateTrainerSummary));
  updateTrainerSummary();

  // "Iniciar" in trainer toggles playback
  trainerStartBtn.addEventListener('click', ()=>{
    const toggleBtn = document.querySelector('#toggleBtn');
    if(!toggleBtn) return;
    // Toggle regardless of current state
    toggleBtn.click();
    // Labels will update via updatePlayLabels()
  });

  function setTrainerActive(on){
  state.trainer.enabled = !!on;
  if(on){
    trainerToggle.textContent = 'Desactivar entrenador';
    trainerToggle.classList.add('active');
    trainerCard.classList.add('active');
    trainerHelp.style.display = 'block';
    trainerStatus.classList.remove('off'); trainerStatus.classList.add('on'); trainerStatus.textContent = 'ON';
    trainerStartBtn.style.display = 'inline-flex'; trainerStartBtn.disabled = false; trainerStartBtn.textContent = state.isRunning ? 'Detener' : 'Iniciar';
  } else {
    trainerToggle.textContent = 'Activar entrenador';
    trainerToggle.classList.remove('active');
    trainerCard.classList.remove('active');
    trainerHelp.style.display = 'none';
    trainerStatus.classList.remove('on'); trainerStatus.classList.add('off'); trainerStatus.textContent = 'OFF';
    trainerStartBtn.style.display = 'none';
  }
  updateTrainerSummary();
  save();
}
  trainerToggle.addEventListener('click', ()=> setTrainerActive(!state.trainer.enabled));

  // Persistencia
  function save(){
    try{
      localStorage.setItem('freeclick.settings.es.accents.toggle', JSON.stringify({
        bpm: state.bpm, num: state.num, den: state.den,
        sound: soundSelect.value, vol: parseFloat(vol.value),
        accents: state.accents, trainerEnabled: state.trainer.enabled
      }));
    }catch(_){}
  }
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem('freeclick.settings.es.accents.toggle')||'{}');
      if(s.bpm) setBpm(s.bpm);
      if(s.num){ state.num = s.num; numSelect.value = String(s.num); }
      if(s.den){ state.den = s.den; denSelect.value = String(s.den); }
      if(s.sound){ soundSelect.value = s.sound; }
      if(s.vol!=null){ vol.value = s.vol; }
      if(typeof s.trainerEnabled === 'boolean'){ setTrainerActive(s.trainerEnabled); } else { setTrainerActive(false); }
      if(Array.isArray(s.accents)){
        // reconstruir luego de buildAccentBar para aplicar
        buildAccentBar();
        state.accents = s.accents.slice(0,state.num).concat(Array(Math.max(0, state.num - s.accents.length)).fill(false));
        // sync pills visuales
        const pills = accentBar.querySelectorAll('.beat-pill');
        pills.forEach((p,i)=> p.classList.toggle('accent', !!state.accents[i]));
      } else {
        buildAccentBar();
      }
    }catch(_){ buildAccentBar(); }
  }
  load();
  [bpmSlider,bpmInput,numSelect,denSelect,soundSelect,vol].forEach(el=> el.addEventListener('change', save));
  accentBar.addEventListener('click', save);

  // Cambios de compás
  numSelect.addEventListener('change', ()=>{ state.num = parseInt(numSelect.value,10); buildAccentBar(); save(); });
  denSelect.addEventListener('change', ()=>{ state.den = parseInt(denSelect.value,10); save(); });

  // Audio gating móvil
  ['click','touchstart'].forEach(ev=>{
    window.addEventListener(ev, ()=> {
      if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume(); }
    }, {passive:true});
  });

  // PWA
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // Valor inicial
  setBpm(120);
})();
</script>
</body>
</html>
